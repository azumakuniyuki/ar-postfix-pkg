---
#                  _    __ _       __      _       __     ___            _        
#  _ __   ___  ___| |_ / _(_)_  __/ /_ __ | | ____ \ \   / / |_ __ _ ___| | _____ 
# | '_ \ / _ \/ __| __| |_| \ \/ / || '_ \| |/ / _` | | / /| __/ _` / __| |/ / __|
# | |_) | (_) \__ \ |_|  _| |>  <| || |_) |   < (_| | |/ / | || (_| \__ \   <\__ \
# | .__/ \___/|___/\__|_| |_/_/\_\ || .__/|_|\_\__, | /_/   \__\__,_|___/_|\_\___/
# |_|                             \_\_|        |___/_/                            
# smtp-filter
- block:
    - name: smtp-filter | RedHat | amavisd-new should be installed
      yum:
        name:  "{{ item }}"
        state: "present"
      with_items:
        - "amavisd-new"
        - "amavisd-milter"

    - name: smtp-filter | RedHat | spamassassin should be installed
      yum:
        name:  "{{ item }}"
        state: "present"
      with_items:
        - "spamassassin"
        - "spamass-milter"
        - "spamass-milter-postfix"

    - name: smtp-filter | RedHat | Clam should be installed
      yum:
        name:  "{{ item }}"
        state: "present"
      with_items:
        - "clamav"
        - "clamav-data"
        - "clamav-devel"
        - "clamav-lib"
        - "clamav-milter"
        - "clamav-milter-systemd"
        - "clamav-scanner-systemd"
        - "clamav-server-systemd"
        - "clamav-update"
        - "clamd"
        - "clamsmtp"

    - name: smtp-filter | RedHat | amavisd.conf should be deployed
      notify: Restart amavis
      template:
        src:  "etc/amavisd.conf.j2"
        dest: "/etc/amavisd.conf"
        mode: "0644"

    - name: smtp-filter | RedHat | ClamAV config files should be deployed
      notify: Restart clamsmtpd
      template:
        src:  "{{ item }}.j2"
        dest: "/etc/clamd.d/{{ item }}.conf"
        mode: "0644"
      with_items:
        - "clamsmtp"
        - "scan"
  when: ansible_os_family == "RedHat"

# -----------------------------------------------------------------------------
- block:
    - name: smtp-filter | Debian | amavisd-new should be installed
      apt:
        name:  "{{ item }}"
        state: "present"
      with_items:
        - "amavisd-new"
        - "amavisd-milter"
        - "dkimproxy"

    - name: smtp-filter | Debian | spamassassin should be installed
      apt:
        name:  "{{ item }}"
        state: "present"
      with_items:
        - "spamassassin"
        - "spamass-milter"

    - name: smtp-filter | Debian | Clam should be installed
      apt:
        name:  "{{ item }}"
        state: "present"
      with_items:
        - "clamav"
        - "clamav-base"
        - "clamav-daemon"
        - "clamav-docs"
        - "clamav-freshclam"
        - "clamav-milter"
        - "clamav-testfiles"
        - "clamdscan"
        - "clamdscan"
        - "clamsmtp"
        - "libclamav7"
        - "libclamav-dev"

    - name: smtp-filter | Debian | Each config files in /etc/amavis/conf.d should be deployed
      notify: Restart amavis
      template:
        src:  "{{ item }}"
        dest: "/etc/amavis/conf.d/{{ item | basename | replace('.j2', '') }}"
        mode: "0644"
      with_fileglob: "templates/etc/amavis/conf.d/*.j2"

    - name: smtp-filter | Debian | ClamAV config files should be deployed
      notify: Restart clamav-daemon
      template:
        src:  "{{ item }}.j2"
        dest: "/etc/clamav/{{ item }}.conf"
        mode: "0644"
      with_items:
        - "clamd"
        - "freshclam"
  when: ansible_os_family == "Debian"
